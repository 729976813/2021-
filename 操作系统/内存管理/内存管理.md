## 内存管理

参考博客：https://blog.csdn.net/qq_29677867/article/details/91038642

### 一、基本原理及要求

1、引入目的：

内存容量**不足以将所有用户进程和系统所需要的全部程序于数据放入**内存，必须对内存空间合理划分和有效动态分配。

2、内存管理的主要功能：

1.内存空间的分配回收（操作系统负责主存储器（内存RAM+ROM）的分配，无需程序员操作）

2.内存空间的扩充：虚拟存储技术或者自动覆盖技术，从逻辑上扩展内存（用外存扩展内存）

3.地址转换：负责将程序的逻辑地址转换为物理地址

4.内存保护：操作系统保证各个进程在各自的存储空间中运行，互不干扰。

![image-20210207164128653](C:\Users\94130\AppData\Roaming\Typora\typora-user-images\image-20210207164128653.png)

### 二、覆盖和交换

1. 覆盖：什么是覆盖？程序并非任何时候需要访问全部的代码，因此可以把用户空间划分把固定区和覆盖区。固定区存在活跃的部分，覆盖区装入即将执行的部分。（早期操作系统中，现已经过时）

2. 交换。内存紧张时，将等待状态的（非运行态）的程序由内存移到外存中。

   适用场景：中级调度，常用时间片轮转法

   注意：

   1.交换后的程序存在外存的什么位置？为外存划分了交换区，该交换区独立于文件系统，速度更快。

   2.什么时候开始交换：内存吃紧的时候，比如很多进程出现**缺页**

   3.那些进程应该交换：阻塞进程、低优先级进程、考虑内存中存在时间。

   

### 三、连续分配管理方式

1、单一连续分配

内存划分为系统区和用户区。系统区位于低地址、用户区高地址。只是用于单用户、单作业的操作系统

![image-20210207174816635](C:\Users\94130\AppData\Roaming\Typora\typora-user-images\image-20210207174816635.png)

什么是外部碎片和内部碎片？

<img src="C:\Users\94130\AppData\Roaming\Typora\typora-user-images\image-20210207175815795.png" alt="image-20210207175815795" style="zoom:150%;" />

2.固定分区分配

将内存分为固定大小的分区，每个分区可以装入一道作业。

数据结构：通过**分区说明表**来表示操作系统的数据结构。每个表项包括对应分**区的大小、起始地址以及状态**。



3.动态分区分配

不预先划分内存分区，而是在进程装入内存时，根据进程占用内存大小动态的分配。

数据结构：空闲分区表或空闲分区链。每个表项包含分区号、分区大小、以及起始地址，状态。

动态分区分配算法：

首次适应、最佳适应、最坏适应以及领近适应算法。





### 四、非连续分配管理方式

1、非连续概念：

非连续：进程分配的存储空间可以式物理上分散的内存空间

连续分配管理方式存在问题：

固定分区：内部碎片

动态分区：外部碎片，紧凑技术时间代价高

所以提出了非连续分配管理

非连续分配管理方式主要分为：页式存储管理、段式存储管理、段页式存储管理

2、基本分页存储管理：

​	**1.基本思想**：把内存分为一个个相等的小分区，再按照分区大小拆分进程内存空间。

2. **分区大小是否固定分为分页存储和分段存储**

![image-20210207200335363](C:\Users\94130\AppData\Roaming\Typora\typora-user-images\image-20210207200335363.png)

用户进程分为大小相等的页面，内存分为同样大小的页框。页面和页框一一对应。

​	**3.页面和页框的关系：**

![image-20210207203907843](C:\Users\94130\AppData\Roaming\Typora\typora-user-images\image-20210207203907843.png)

​	平均碎片大小为M/2,M为页面页框的大小

​	**4.逻辑地址结构**

​	页号+页面偏移量

​	1个页面大小就是页面偏移量的所能表示的范围

​	页号的最大值就是页面的数量

​	**5.页表**

​	引入的目的和概念：知道每个“页面”在内存中“页帧”的位置。操作系统为每个进程建立一张页表

​	页表通常在PCB中，每个页表项由页号和块号组成

​	页号隐藏在数组下表中，块号用一定位数二进制码组成，可以表示页内所有地址。

​	页面大小刚好是2的整数幂可以加快地址转换计算。

​	**6.基本地址转换机构**

​	目的和概念：借助页表将逻辑地址转换为物理地址

​	页表寄存器PRT：进程未执行，页表存在PCB中，进程被调度后，页表放入PRT中

​	地址变化过程：逻辑地址算出页号、偏移量；页号越界检查；根据页表寄存器中的页表地址、页号找到页表项；根据页表项查到物理地址（访问内存中的页表、一次访存）；根据物理地址访问内存地址（二次访存）

​	缺点：两次访存速度较慢。

​	7.快表TLB

​	引入目的：解决基本地址转换机构两次访存速度慢的缺点。

​	局部性: 指时间局部性和空间局部性。

​	定义：又名联想寄存器，是一种访问速度比内存快很多的高速缓存，用来存放最近访问的页表项的副本。

​	快表和缓存的区别：TLB中只有页表项的副本，Cache中可能会有其他各种数据的副本。

​	8.两级页表

​	引入目的：由于单级页表必须连续存放，如果页表太大的话，需要占用很大的连续空间。其次，很多页面并非每个时间段都在使用，没必要常驻内存。

​	页目录表/顶级页表/外层页表，用来建立不同二级页表所在内存位置。

3、基本分段存储管理：

进程的地址空间**按照自身逻辑**化为多个段，每个段在内存空间连续，各段可不相邻。

段表：段表项：基址+段长

地址寻址：根据逻辑地址得到段号+段内地址

4.分段分页对比

分页对用户不可见、分段对用户可见（用户的程序逻辑）

页的大小由系统决定，段的长度不固定，由用户的程序决定

分段的方法中，每次程序运行把程序全部装入内存。分页运行到哪页装入哪页

分页地址式一维的，逻辑地址包含页号和页内偏移量。分段地址是二维的包含段号和段内偏移地址。



![image-20210208170818537](C:\Users\94130\AppData\Roaming\Typora\typora-user-images\image-20210208170818537.png)	

5.段页式存储

将程序分段，每段在分页，内存分成同样大小的页框

访问方式：查段表、查页表、访问目标单元。

段表寄存器和页表寄存器：在段、页中寻址；判断是否越界。